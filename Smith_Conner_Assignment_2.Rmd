*---
title: "ESM 204 - Assignment 2"
author: "Conner Smith"
date: "4/13/2022"
output:
  html_document:
   theme:
     bg: "#002B36"
     fg: "#EEE8D5"
     primary: "#2AA198"
   code_folding: hide
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(tidyverse)
library(here)
library(janitor)
library(thematic)
library(scales)
library(equatiomatic)

thematic::thematic_rmd()
thematic::thematic_on()

```


## Overview

```{r}
# Read in the main data set

districts <- read_csv(here("Water_Districts.csv")) %>% 
  clean_names() %>% 
  select(-x1)

# Adding image
#include_graphics(here('chinook.jpg'))
```

[Source: Corvallis Advocate](https://www.corvallisadvocate.com/2020/army-corps-failed-to-protect-willamette-river-salmon-judge-rules/)

Agricultural water is managed by irrigation districts and is increasingly scarce. To conserve water and reduce costs, four irrigation districts are considering developing a water market, in which water rights would be traded across the districts. In this homework you will conduct data analysis, simulations, and policy analysis to help inform the development of the water market. 

**Data Citation**
*University of Washington, Columbia Basin Research. 2010. DART Adult Passage Graphics & Text.* http://www.cbr.washington.edu/dart/query/adult_graph_text.

## **Analysis** {.tabset}

The dataset contains estimates of the marginal cost of reducing water use in each of the four irrigation districts (Kern, Mojave, Antelope, and Ventura) for different levels of reduction (in Acre Feet).

Current (i.e. baseline) water use in these districts is: 

- Kern = 150 AF
- Mojave = 140 AF
- Antelope = 220 AF 
- Ventura = 245 AF

Prices are in $/Acre Foot and quantities are in Acre Feet (AF).


### **1. Abatement Costs**

For each irrigation district, plot the marginal abatement cost data (from the data provided) and estimate a linear regression model with zero intercept. These estimated linear regressions will be your estimates of the marginal abatement cost curve (one for each irrigation district), which you will use for the remainder of this analysis.

#### **Figure 1: MC Across Counties**
```{r}
districts_sub <- districts %>% 
  rename(kern = mc_kern,
         mojave = mc_mojave,
         antelope = mc_antelope,
         ventura = mc_ventura) %>% 
  pivot_longer(cols = c(kern, mojave, antelope, ventura),
               names_to = 'county',
               values_to = 'mc')

ggplot(data = districts_sub, aes(x = reduction, y = mc)) + 
  geom_point(aes(color = county)) +
  scale_color_manual("County", 
                     values = c('cadetblue3', 'darkgoldenrod1',
                     'darkolivegreen4', 'sienna2')) +
  labs(x = "Reduction (AF)", y = "Marginal Cost ($/AF)")

# Linear model for Kern MC forcing 0 intercept 

lm_kern <- lm(mc_kern ~ 0 + reduction, data = districts)
extract_eq(model = lm_kern, use_coefs = TRUE)

# Linear model for Mojave MC forcing 0 intercept 

lm_mojave <- lm(mc_mojave ~ 0 + reduction, data = districts)
extract_eq(model = lm_mojave, use_coefs = TRUE)

# Linear model for Antelope MC forcing 0 intercept 

lm_antelope <- lm(mc_antelope ~ 0 + reduction, data = districts)
extract_eq(model = lm_antelope, use_coefs = TRUE)

# Linear model for Ventura MC forcing 0 intercept 

lm_ventura <- lm(mc_ventura ~ 0 + reduction, data = districts)
extract_eq(model = lm_ventura, use_coefs = TRUE)

```


### **2. Demand Assessment**

```{r}
# Make a predict data set from the linear models 

kern_predict <- predict(lm_kern)
mojave_predict <- predict(lm_mojave)
antelope_predict <- predict(lm_antelope)
ventura_predict <- predict(lm_ventura)

districts_predict <- data.frame(districts, kern_predict, mojave_predict, antelope_predict, ventura_predict)

# Now clean this like before 

districts_predict_clean <- districts_predict %>% 
  select(-mc_kern, -mc_mojave, -mc_antelope, -mc_ventura) %>% 
  rename(kern = kern_predict,
         mojave = mojave_predict,
         antelope = antelope_predict,
         ventura = ventura_predict) %>% 
  pivot_longer(cols = c(kern, mojave, antelope, ventura),
               names_to = 'county',
               values_to = 'mc')

# This will be the new MC data set 
  
```

Using your estimated marginal abatement cost curves, derive each district’s demand curve for water. In other words, how much would each district be willing to pay for the right to use the first AF of water, second AF, etc.? Plot each district’s demand curve on a single graph. Which sector is willing to pay the most for the first AF of water?

#### **Figure X**

```{r}
# Caluclate demand curves:
# Kern (Baseline = 150) --> 2.29(A) 
## 2.29(150 - A) --> 343.5 - 2.29A

reduction <- districts$reduction
kern_demand <- function(reduction){
 demand = 343.5 - 2.29*(reduction)
return(demand)
}


# Mojave (Baseline = 140) --> 3.8(A)
## 3.8(140 - A) --> 532 - 3.8A
mojave_demand <- function(reduction){
 demand = 532 - 3.8*(reduction)
return(demand)
}

# Antelope (Baseline = 220) --> 2.86(A)
## 2.86(220 - A) --> 629.2 - 2.86A

antelope_demand <- function(reduction){
 demand = 629.2 - 2.86*(reduction)
return(demand)
}

# Ventura (Baseline = 245) --> 1.78(A)
## 1.78(245 - A) --> 436.1 - 1.78A

ventura_demand <- function(reduction){
 demand = 436.1 - 1.78*(reduction)
return(demand)
}

demand_water <- seq(0,300, by = 1)
ventura_p <- ventura_demand(demand_water)
kern_p <- kern_demand(demand_water)
mojave_p <- mojave_demand(demand_water)
antelope_p <- antelope_demand(demand_water)


ggplot(data = districts_predict_clean, aes(x = reduction, y = mc)) +
  geom_line(aes(color = county, ymax = 650)) +
  scale_color_manual("County", 
                     values = c('cadetblue3', 'darkgoldenrod1',
                     'darkolivegreen4', 'sienna2')) +
  geom_abline(color = "darkgoldenrod1",
              intercept = 343.5, slope= -lm_kern$coefficients) +
  annotate("text", x = 10, y = 343, 
           label = "Kern Demand", angle = -22) +
  geom_abline(color = "darkolivegreen4",
              intercept = 532, slope= -lm_mojave$coefficients) +
  annotate("text", x = 20, y = 480, 
           label = "Mojave Demand", angle = -30) +
  geom_abline(color = "cadetblue3",
              intercept = 629.2, slope= -lm_antelope$coefficients) +
  annotate("text", x = 50, y = 520, 
           label = "Antelope Demand", angle = -25) +
  geom_abline(color = "sienna2",
              intercept = 436.1, slope= -lm_ventura$coefficients) +
  annotate("text", x = 10, y = 440, 
           label = "Ventura Demand", angle = -19) +
  labs(x = "Reduction (AF)", y = "Marginal Cost ($/AF)")

```

#### *This graph shows both water demand (downward sloping lines) and marginal cost of abatement (upward sloping lines), color coded for each county.*  

Based on the graph above, Antelope County is willing to pay the most for the first unit of water. 

### **3. Policy Considerations**

Here you will analyze three alternative policies for reducing water use among these irrigation districts. In total, these irrigation districts will need to reduce water consumption from the current 755 AF down to 500 AF. 

#### **Cap Without Trade**

```{r}
# Cap without trade. Reduce each district’s water use by the same fraction (e.g., 1/3 of current baseline use), so the 500 AF target is met. (multiplier is 0.338)

fraction <- 0.662
kern_use_cap <- 150*fraction
#50.7 reduced 
mojave_use_cap <- 140*fraction 
#47.32 reduced
antelope_use_cap <- 220*fraction
#74.36 reduced
ventura_use_cap <- 245*fraction
#82.81 reduced

#mojave_cap+ventura_cap+antelope_cap+kern_cap --> This all adds up to 500 AF, the total use 

# But cost is a function of abatement, so we need the abatement values instead.

kern_abate_cap <- 150-kern_use_cap
mojave_abate_cap <- 140-mojave_use_cap
antelope_abate_cap <- 220-antelope_use_cap
ventura_abate_cap <- 245-ventura_use_cap
# DON'T KNOW ABOUT STRINGENCY HERE

# Cost, plug in REDUCTION to each district's cost curve, then take the area under the marginal cost curve for each at the given price/quantity reduction

kern_price_cap <- 2.28*kern_abate_cap
kern_cost_cap <- 0.5*kern_price_cap*kern_abate_cap

mojave_price_cap <- 2.28*mojave_abate_cap
mojave_cost_cap <- 0.5*mojave_price_cap*mojave_abate_cap

antelope_price_cap <- 2.28*antelope_abate_cap
antelope_cost_cap <- 0.5*antelope_price_cap*antelope_abate_cap

ventura_price_cap <- 2.28*ventura_abate_cap
ventura_cost_cap <- 0.5*ventura_price_cap*ventura_abate_cap

total_cost_cap = ventura_cost_cap + kern_cost_cap + antelope_cost_cap + mojave_cost_cap
```

*(1)* Stringency of this policy is defined as the magnitude of the fraction for reduction. In this case, that is equal to `r fraction`. 

*(2)* Total cost of this approach is $`r total_cost_cap`.

*(3)* Individual district costs are as follows:
- Kern : $`r kern_cost_cap`
- Mojave: $`r mojave_cost_cap`
- Antelope: $`r antelope_cost_cap`
- Ventura: $`r ventura_cost_cap`

*(4)* This policy does not generate tax revenue.

Ventura County bears the highest individual cost as a result of this cap without trade policy which applies an equal fractional reduction to the baseline water use in each district. 

#### **Tax on Water Use**

```{r}
# Tax applied to reach 500 AF level, 255 AF reduction 
# Calculate aggregate demand to get the price at which cumulative water use is 500 AF

# Add together the inverse slopes of each MC curve 

aggregate_cost_slope <- 1/(1/2.29 + 1/3.8 + 1/2.86 + 1/1.78)

tax_level <- 0.621*255 

# Tax of $158/AF is applied across all counties. 

# Now we need to see cost to each district, plug the price into the individual MC curves then take the area under each and sum for total. 

# Kern
# tax_level = 2.29A
kern_abate_tax <- tax_level/2.29
# 69.15 AF
kern_cost_tax <- 0.5*tax_level*kern_abate_tax

# Mojave
# tax_level = 3.8A
mojave_abate_tax <- tax_level/3.8
#41.67 AF
mojave_cost_tax <- 0.5*tax_level*mojave_abate_tax

#Antelope
# tax_level = 2.86A
antelope_abate_tax = tax_level/2.86
# 55.37 AF
antelope_cost_tax <- 0.5*tax_level*antelope_abate_tax

# Ventura
# tax_level = 1.78A 
ventura_abate_tax = tax_level/1.78
# 88.96
ventura_cost_tax <- 0.5*tax_level*ventura_abate_tax

#ventura_abate_tax+mojave_abate_tax+antelope_abate_tax+kern_abate_tax
# Total abatement still 255 

total_cost_tax = ventura_cost_tax+antelope_cost_tax+mojave_cost_tax+kern_cost_tax

# Revenue is the tax times the AF used. 
tax_revenue <- tax_level*500
```

*(1)* Stringency of this policy is defined as the magnitude of the tax for reduction. In this case, that is equal to $`r tax_level`. 

*(2)* Total cost of this approach is $`r total_cost_tax`.

*(3)* Individual district costs are as follows:
- Kern : $`r kern_cost_tax`
- Mojave: $`r mojave_cost_tax`
- Antelope: $`r antelope_cost_tax`
- Ventura: $`r ventura_cost_tax`

*(4)* Tax revenue generted is $`r tax_revenue` based on 500AF of total use.

#### **Cap and Trade**
From part (a), we have the cost to each district for the cap without trade as: 

- Kern : $`r kern_cost_cap`, reduction of 50.7 AF 
- Mojave: $`r mojave_cost_cap`, reduction of 42.73 AF
- Antelope: $`r antelope_cost_cap`, reduction of 74.36 AF
- Ventura: $`r ventura_cost_cap`, reduction of 82.81 AF

We also have the total cost from above as: $`r total_cost_cap`.


```{r}
# Given the total marginal cost, we should assume these will be set equal for firms to get the quantity


```




### **4. Drought Sensitivity**

A severe drought hits California, and it is necessary to reduce water use from 500 AF down to 300 AF. Your job is to estimate the cost of the drought (i.e., the cost of reducing water use from 500 AF to 300 AF) to each irrigation district under each policy. Considering the entire jump from status quo (755 AF) to the drought (300 AF), which policy is preferred by each irrigation district? How does your answer depend on 
how rights are allocated to each district (in policies (a) and (c))
